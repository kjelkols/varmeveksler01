<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Simulering av platevarmeveksler</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h1 { color: #0078d7; }
        .input-section, .report-section { margin-bottom: 2em; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1em; font-size: 0.95em; }
    th, td { border: 1px solid #ccc; padding: 0.15em 0.3em; text-align: left; line-height: 1.1; }
    th { background: #f0f0f0; }
        .drop-area { border: 2px dashed #888; border-radius: 6px; background: #f9f9f9; padding: 1em; text-align: center; color: #888; margin-bottom: 1em; transition: background 0.2s, border-color 0.2s; }
        .error { color: #b00; margin-top: 1em; }
        .button-row { margin-bottom: 1em; }
        button, input[type="file"] { margin-right: 1em; }
    </style>
</head>
<body>
<div class="container">
    <h1>Simulering av platevarmeveksler</h1>
    <div class="input-section">
        <form id="input-form">
            <div class="button-row">
                <label for="json-upload" style="font-weight:bold;">Last opp inndata</label>
                <input type="file" id="json-upload" accept="application/json" style="display:none;">
                <button type="button" id="json-upload-btn">Last opp inndata</button>
                <span id="json-upload-label">(json-format)</span>
                <button type="button" id="json-download">Last ned inndata</button>
            </div>
            <div id="drop-area" class="drop-area">Dra og slipp en JSON-fil her for å laste opp</div>
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Verdi</th>
                </tr>
                <tr>
                    <td>flow_arrangement</td>
                    <td>
                        <select name="flow_arrangement">
                            <option value="counter-flow" {% if input_data['flow_arrangement'] == 'counter-flow' %}selected{% endif %}>counter-flow</option>
                            <option value="cross-flow" {% if input_data['flow_arrangement'] == 'cross-flow' %}selected{% endif %}>cross-flow</option>
                        </select>
                    </td>
                </tr>
                {% for k in input_data['exchanger'].keys() %}
                <tr>
                    <td>{{ k }}</td>
                    <td>
                        <input name="exchanger.{{k}}" type="number" step="any" value="{{ input_data['exchanger'][k] }}">
                    </td>
                </tr>
                {% endfor %}
            </table>
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Luftstrøm 1</th>
                    <th>Luftstrøm 2</th>
                </tr>
                {% for k in input_data['airstream_1'].keys() %}
                <tr>
                    <td>{{ k }}</td>
                    <td><input name="airstream_1.{{k}}" type="number" step="any" value="{{ input_data['airstream_1'][k] }}"></td>
                    <td><input name="airstream_2.{{k}}" type="number" step="any" value="{{ input_data['airstream_2'][k] }}"></td>
                </tr>
                {% endfor %}
            </table>
        </form>
    </div>
    <div class="report-section">
        <h2>Rapport</h2>
        <div id="report-area">{{ report_html|safe }}</div>
        <div class="error" id="error-area">{{ error|safe }}</div>
    </div>
</div>
<script>

// Tilpasset filopplasting-knapp og tekst
const uploadInput = document.getElementById('json-upload');
const uploadBtn = document.getElementById('json-upload-btn');
const uploadLabel = document.getElementById('json-upload-label');
uploadBtn.addEventListener('click', function() {
    uploadInput.click();
});
uploadInput.addEventListener('change', function() {
    if (uploadInput.files.length > 0) {
        // uploadLabel.textContent = uploadInput.files[0].name;
        uploadLabel.textContent = '(json-format)';
    } else {
        uploadLabel.textContent = '(json-format)';
    }
});


// Filopplasting via input
document.getElementById('json-upload').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            fetch('/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(obj => {
                if (obj.error) {
                    document.getElementById('error-area').textContent = obj.error;
                } else {
                    document.getElementById('error-area').textContent = '';
                    // Oppdater skjema med gyldige verdier fra fil
                    for (const section of ['airstream_1', 'airstream_2', 'exchanger']) {
                        if (!data[section]) continue;
                        for (const key in data[section]) {
                            const input = document.querySelector(`[name="${section}.${key}"]`);
                            if (input) input.value = data[section][key];
                        }
                    }
                    updateReport();
                }
            });
        } catch (err) {
            const errorArea = document.getElementById('error-area');
            if (errorArea) {
                errorArea.textContent = 'Kunne ikke lese JSON: ' + err;
            } else {
                alert('Kunne ikke lese JSON: ' + err);
            }
        }
    };
    reader.readAsText(file);
});

// Nedlasting av inndata
document.getElementById('json-download').addEventListener('click', function() {
    const data = getFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inndata.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// Forbedret drag-and-drop: visuell feedback og aktivering
const dropArea = document.getElementById('drop-area');
let dragCounter = 0;
document.addEventListener('dragenter', function(e) {
    e.preventDefault();
    dragCounter++;
    dropArea.style.background = '#e0e0e0';
    dropArea.style.borderColor = '#0078d7';
});
document.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dragCounter--;
    if (dragCounter <= 0) {
        dropArea.style.background = '#f9f9f9';
        dropArea.style.borderColor = '#888';
    }
});
document.addEventListener('dragover', function(e) {
    e.preventDefault();
});
dropArea.addEventListener('drop', function(e) {
    e.preventDefault();
    dragCounter = 0;
    dropArea.style.background = '#f9f9f9';
    dropArea.style.borderColor = '#888';
    const file = e.dataTransfer.files[0];
    if (!file) return;
    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        alert('Bare JSON-filer støttes.');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const data = JSON.parse(ev.target.result);
            for (const section of ['airstream_1', 'airstream_2', 'exchanger']) {
                if (!data[section]) continue;
                for (const key in data[section]) {
                    const input = document.querySelector(`[name="${section}.${key}"]`);
                    if (input) input.value = data[section][key];
                }
            }
            updateReport();
        } catch (err) {
            alert('Kunne ikke lese JSON: ' + err);
        }
    };
    reader.readAsText(file);
});

function getFormData() {
    const form = document.getElementById('input-form');
    const data = { airstream_1: {}, airstream_2: {}, exchanger: {} };
    for (const el of form.elements) {
        if (!el.name) continue;
        const [section, key] = el.name.split('.');
        
        if (section === 'exchanger' && key === 'flow_arrangement') {
            data['flow_arrangement'] = el.value;
        } else {
            if (el.type === 'number') {
                data[section][key] = parseFloat(el.value);
            } else {
                data[section][key] = el.value;
            }
        }
    }
    return data;
}
function updateReport() {
    const data = getFormData();
    fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(obj => {
        document.getElementById('report-area').innerHTML = obj.report_html;
        document.getElementById('error-area').innerHTML = obj.error || '';
    });
}
document.getElementById('input-form').addEventListener('input', updateReport);
window.onload = updateReport;
</script>
</body>
</html>
